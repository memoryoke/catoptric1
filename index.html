<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Adaptive Quadrant Processor</title>

<style>
/* --- BASE STYLES (Mobile First: Vertical Stack) --- */
body {
  margin: 0;
  background: #111;
  color: #eee;
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

#app {
  width: 100%;
  display: flex;
  flex-direction: column;
}

canvas {
  width: 100%;
  aspect-ratio: 1 / 1;
  background: #000;
  image-rendering: pixelated;
  display: block;
}

#controls {
  width: 100%;
  background: #1a1a1a;
  padding: 1rem;
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4-column base grid */
  gap: 0.6rem;
  box-sizing: border-box;
}

/* --- DESKTOP ADAPTATION (Wider than 900px) --- */
@media (min-width: 1050px) {
  body {
    justify-content: center;
    padding: 20px;
  }
  
  #app {
    max-width: 1100px;
    flex-direction: row; /* Side-by-side */
    align-items: flex-start;
    gap: 20px;
  }

  canvas {
    width: 550px; 
    position: sticky;
    top: 20px;
    border-radius: 8px;
  }

  #controls {
    flex: 1;
    border-radius: 8px;
    grid-template-columns: repeat(4, 1fr); /* Keep 4 cols for button math */
  }
}

/* --- BUTTONS & ELEMENTS --- */
.button {
  background: #333;
  border: 1px solid #444;
  color: #fff;
  padding: 0.8rem 0.2rem;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.button:active { background: #444; }
.button.active-effect { background: #007bff; border-color: #00a2ff; }

/* Equal sized effect buttons: 1/4 width each */
.effect-button {
  grid-column: span 1; 
}

.slider-wrap {
  grid-column: span 4;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
  font-size: 0.75rem;
  background: #222;
  padding: 10px;
  border-radius: 4px;
}

.slider-header {
  display: flex;
  justify-content: space-between;
  color: #aaa;
}

input[type="range"] { width: 100%; cursor: pointer; }

.span-2 { grid-column: span 2; }
.span-4 { grid-column: span 4; }

#gridSizeDisplay {
  grid-column: span 4;
  text-align: center;
  font-family: monospace;
  background: #000;
  padding: 0.5rem;
  border-radius: 4px;
  color: #00ffcc;
  font-weight: bold;
}

#videoFeed { display: none; }
</style>
</head>

<body>

<div id="app">
  <canvas id="canvas"></canvas>

  <div id="controls">
    <div id="gridSizeDisplay">GRID: 10×10</div>

    <button id="startWebcamButton" class="button span-2">Start</button>
    <button id="freezeButton" class="button span-2">Freeze/Unfreeze</button>
    
    <label class="button span-4">
      <input id="autoGridToggle" type="checkbox" style="margin-right: 8px;"> Auto
    </label>

    <div class="slider-wrap">
      <div class="slider-header"><span>Grid Density</span><span id="val-grid">10</span></div>
      <input id="gridSlider" type="range" min="1" max="50" value="10">
    </div>

    <div class="slider-wrap">
      <div class="slider-header"><span>Brightness</span><span id="val-bright">100%</span></div>
      <input id="brightnessSlider" type="range" min="50" max="150" value="100">
    </div>
  <div class="slider-wrap">
      <div class="slider-header"><span>Contrast</span><span id="val-contrast">100%</span></div>
      <input id="contrastSlider" type="range" min="50" max="150" value="100">
    </div>
    <div class="slider-wrap">
      <div class="slider-header"><span>Saturation</span><span id="val-sat">100%</span></div>
      <input id="saturationSlider" type="range" min="0" max="200" value="100">

    <button id="effectA1" class="button effect-button">Agnes</button>
    <button id="effectA2" class="button effect-button">Bridget</button>
    <button id="effectB1" class="button effect-button">Chuck</button>
    <button id="effectB2" class="button effect-button">Donald</button>

    <button id="clearEffectButton" class="button span-2">Original</button>
    <button id="downloadButton" class="button span-2" style="background:#28a745; border-color: #1e7e34;">Download</button>

  
    </div>
  </div>
</div>

<video id="videoFeed" playsinline autoplay muted></video>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const video = document.getElementById('videoFeed');
const offscreenCanvas = document.createElement('canvas');
const offscreenCtx = offscreenCanvas.getContext('2d', { willReadFrequently: true });

let stream = null, frozen = false, gridSize = 10, autoGrid = false;
let currentEffect = 'A1', brightness = 100, contrast = 100, saturation = 100;
let lastAutoUpdate = 0;

/* --- UI Handlers --- */
const updateVal = (id, val) => document.getElementById(id).textContent = val;

document.getElementById('gridSlider').oninput = (e) => {
  if (!autoGrid) {
    gridSize = parseInt(e.target.value);
    updateVal('val-grid', gridSize);
    document.getElementById('gridSizeDisplay').textContent = `GRID: ${gridSize}×${gridSize}`;
  }
};

document.getElementById('brightnessSlider').oninput = (e) => { brightness = e.target.value; updateVal('val-bright', brightness + '%'); };
document.getElementById('contrastSlider').oninput = (e) => { contrast = e.target.value; updateVal('val-contrast', contrast + '%'); };
document.getElementById('saturationSlider').oninput = (e) => { saturation = e.target.value; updateVal('val-sat', saturation + '%'); };
document.getElementById('autoGridToggle').onchange = (e) => autoGrid = e.target.checked;

function setEffect(e) {
  currentEffect = e;
  document.querySelectorAll('.effect-button').forEach(b => b.classList.toggle('active-effect', b.id === `effect${e}`));
}

['A1','A2','B1','B2'].forEach(e => document.getElementById(`effect${e}`).onclick = () => setEffect(e));
document.getElementById('clearEffectButton').onclick = () => setEffect(null);

/* --- Camera Setup --- */
document.getElementById('startWebcamButton').onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    video.srcObject = stream;
    await video.play();
    
    // Set internal resolution based on video feed
    const size = Math.min(video.videoWidth, video.videoHeight);
    canvas.width = canvas.height = size;
    offscreenCanvas.width = offscreenCanvas.height = size;
    
    loop();
  } catch (err) {
    alert("Camera access denied or not available. Please ensure you are using HTTPS.");
  }
};

document.getElementById('freezeButton').onclick = () => {
  frozen = !frozen;
  document.getElementById('freezeButton').classList.toggle('active-effect', frozen);
};

/* --- Main Processing Loop --- */
function loop() {
  if (!stream) return;

  if (!frozen) {
    offscreenCtx.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
    const sx = (video.videoWidth - canvas.width) / 2;
    const sy = (video.videoHeight - canvas.height) / 2;
    offscreenCtx.drawImage(video, sx, sy, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
  }

  if (autoGrid) handleAutoGrid();

  if (currentEffect) {
    renderKaleidoscope();
  } else {
    ctx.drawImage(offscreenCanvas, 0, 0);
  }

  requestAnimationFrame(loop);
}

function handleAutoGrid() {
  const now = Date.now();
  if (now - lastAutoUpdate < 150) return;

  const data = offscreenCtx.getImageData(0, 0, canvas.width, canvas.height).data;
  let sum = 0;
  for (let i = 0; i < data.length; i += 120) {
    sum += (0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2]);
  }
  const avg = sum / (data.length / 120);
  const newSize = Math.max(1, Math.min(50, Math.round((avg / 255) * 50)));

  if (Math.abs(newSize - gridSize) > 2) {
    gridSize = newSize;
    updateVal('val-grid', gridSize);
    document.getElementById('gridSizeDisplay').textContent = `GRID: ${gridSize}×${gridSize}`;
  }
  lastAutoUpdate = now;
}

function renderKaleidoscope() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.imageSmoothingEnabled = false;

  const step = canvas.width / gridSize;
  const half = step / 2;

  for (let r = 0; r < gridSize; r++) {
    for (let c = 0; c < gridSize; c++) {
      const cx = c * step + half;
      const cy = r * step + half;

      let sx = c * step;
      let sy = r * step;
      if (currentEffect === 'A2') sx += half;
      if (currentEffect === 'B1') sy += half;
      if (currentEffect === 'B2') { sx += half; sy += half; }

      [{x:1,y:1},{x:-1,y:1},{x:1,y:-1},{x:-1,y:-1}].forEach(t => {
        ctx.save();
        ctx.translate(cx, cy);
        ctx.scale(t.x, t.y);
        ctx.drawImage(offscreenCanvas, sx, sy, half, half, 0, 0, half, half);
        ctx.restore();
      });
    }
  }
}

document.getElementById('downloadButton').onclick = () => {
  const a = document.createElement('a');
  a.download = `LeeCampbellCatoptric2026}.png`;
  a.href = canvas.toDataURL();
  a.click();
};

// Default effect
setEffect('A1');
</script>

</body>
</html>
